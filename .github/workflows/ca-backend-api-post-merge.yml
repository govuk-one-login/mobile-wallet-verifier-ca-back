name: CA Backend application Post Merge
on:
  push:
    branches:
      - main

  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  packages: read

defaults:
  run:
    shell: bash

jobs:
  ci-checks:
    name: Pre-deployment
    uses: ./.github/workflows/job_ci-checks.yml
    with:
      PRIVATE_PACKAGES_REQUIRED: true

  run-test-suite:
    name: Pre-deployment
    uses: ./.github/workflows/job_test-suite.yml
    with:
      PRIVATE_PACKAGES_REQUIRED: true
      RUN_PACT_TESTS: true
      PUBLISH_PACT_VERIFICATION_RESULTS: true
      SONARQUBE_CONTINUE_ON_ERROR: true
      WORKING_DIRECTORY: ./
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  upload-sam-artifact-dev:
    name: Dev
    uses: ./.github/workflows/job_upload-sam-artifact.yml
    with:
      GENERATE_OPEN_PROXY_API_SPEC: true
    secrets:
      ARTIFACT_BUCKET: ${{ secrets.DEV_ARTIFACT_BUCKET }}
      GH_ACTIONS_ROLE_ARN: ${{ secrets.DEV_GH_ACTIONS_ROLE_ARN }}
      SIGNING_PROFILE_NAME: ${{ secrets.DEV_SIGNING_PROFILE_NAME }}

  upload-sam-artifact-build:
    name: Build
    uses: ./.github/workflows/job_upload-sam-artifact.yml
    with:
      GENERATE_OPEN_PROXY_API_SPEC: true
      WORKING_DIRECTORY: backend-api
    secrets:
      ARTIFACT_BUCKET: ${{ secrets.BUILD_ARTIFACT_BUCKET }}
      GH_ACTIONS_ROLE_ARN: ${{ secrets.BUILD_GH_ACTIONS_ROLE_ARN }}
      SIGNING_PROFILE_NAME: ${{ secrets.BUILD_SIGNING_PROFILE_NAME }}
